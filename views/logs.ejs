<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title><%= title %></title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
    />
    <style>
      body {
        background: #f8f9fb;
        font-family: "Poppins", sans-serif;
      }
      .logs-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.7rem;
      }
      .logs-table th,
      .logs-table td {
        font-size: 15px;
      }
      .logs-table thead th {
        background: #212529;
        color: #fff;
      }
      .category-alarm {
        color: #ffb300;
        font-weight: bold;
      }
      .category-brankas {
        color: #0d6efd;
        font-weight: bold;
      }
      .category-wa {
        color: #25d366;
        font-weight: bold;
      }
      .category-server {
        color: #212529;
        font-weight: bold;
      }
      .level-info {
        color: #198754;
      }
      .level-warn {
        color: #fd7e14;
      }
      .level-error {
        color: #dc3545;
        font-weight: bold;
      }
      .filter-btn {
        border-radius: 50%;
        background: #fff;
        color: #495057;
        border: 1.5px solid #dee2e6;
        padding: 7px 11px;
        font-size: 1.18em;
        box-shadow: 0 2px 8px #dee2e633;
        transition: 0.2s;
      }
      .filter-btn.active,
      .filter-btn:hover {
        background: #212529;
        color: #fff;
        border-color: #212529;
      }
      .popover {
        min-width: 270px;
      }
      .form-select-sm,
      .form-control-sm {
        font-size: 0.96em;
      }
      .daterange-input {
        font-size: 0.96em;
      }
      .back-btn {
        min-width: 120px;
      }
      @media (max-width: 800px) {
        .logs-header {
          flex-direction: column;
          align-items: stretch;
          gap: 15px;
        }
        .logs-table th,
        .logs-table td {
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container my-4">
      <!-- HEADER -->
      <div class="logs-header">
        <h4 class="mb-0 d-flex align-items-center" style="gap: 8px">
          <span style="font-size: 1.7em">ðŸ“‹</span>
          <span style="vertical-align: middle"><%= title %></span>
        </h4>
        <div class="d-flex gap-2 align-items-center">
          <button class="filter-btn" id="filterPopoverBtn" title="Filter Data">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="19"
              height="19"
              fill="currentColor"
              class="bi bi-funnel"
              viewBox="0 0 16 16"
            >
              <path
                d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .4.8l-4.545 6.06A2 2 0 0 0 9 9.197V14.5a.5.5 0 0 1-.724.447l-2.5-1.25A.5.5 0 0 1 5.5 13.5V9.197a2 2 0 0 0-.855-1.337L.1 1.8A.5.5 0 0 1 .5 1.5z"
              />
            </svg>
          </button>
          <a href="/" class="btn btn-secondary back-btn">&larr; Home</a>
        </div>
      </div>
      <!-- Filter Popover Content -->
      <div id="filterPopoverContent" class="d-none">
        <div class="mb-2">
          <label class="form-label fw-semibold">Kategori:</label>
          <select id="categoryFilter" class="form-select form-select-sm">
            <option value="">Semua</option>
            <option value="alarm">alarm</option>
            <option value="brankas">brankas</option>
            <option value="wa">wa</option>
            <option value="server">server</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label fw-semibold">Level:</label>
          <select id="levelFilter" class="form-select form-select-sm">
            <option value="">Semua</option>
            <option value="info">info</option>
            <option value="warn">warn</option>
            <option value="error">error</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label fw-semibold">Tanggal:</label>
          <input
            type="text"
            id="dateRange"
            class="form-control form-control-sm daterange-input"
            autocomplete="off"
            placeholder="Rentang tanggal"
          />
        </div>
        <div class="mb-1 d-flex justify-content-end gap-2">
          <button id="resetFilter" class="btn btn-sm btn-outline-secondary">
            Reset
          </button>
        </div>
      </div>
      <!-- TABEL LOGS -->
      <div class="table-responsive mt-2">
        <table
          id="logsTable"
          class="table table-bordered logs-table bg-white shadow-sm"
        >
          <thead class="table-dark">
            <tr>
              <th>Date</th>
              <th>Category</th>
              <th>Level</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody>
            <% if (logs.length === 0) { %>
            <tr>
              <td colspan="4" class="text-center text-muted">
                Belum ada data logs.
              </td>
            </tr>
            <% } else { %> <% logs.forEach((log) => { %>
            <tr>
              <td>
                <%= log.date.toLocaleString ? log.date.toLocaleString() :
                log.date %>
              </td>
              <td class="category-<%= log.category %>"><%= log.category %></td>
              <td class="level-<%= log.level %>"><%= log.level %></td>
              <td style="font-size: 13px"><%= log.message %></td>
            </tr>
            <% }) %> <% } %>
          </tbody>
        </table>
      </div>
    </div>
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
      let table = $("#logsTable").DataTable({
        order: [[0, "desc"]],
        pageLength: 25,
        language: {
          search: "Cari:",
          lengthMenu: "Tampil _MENU_ data",
          info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
          zeroRecords: "Tidak ditemukan data",
          paginate: { first: "Awal", last: "Akhir", next: "â†’", previous: "â†" },
        },
      });

      // --- Filter Popover --- (tidak berubah dari sebelumnya)
      const filterBtn = document.getElementById("filterPopoverBtn");
      const popoverContent = document.getElementById("filterPopoverContent");
      let bsPopover;
      filterBtn.addEventListener("click", function () {
        if (!bsPopover) {
          bsPopover = new bootstrap.Popover(filterBtn, {
            html: true,
            placement: "bottom",
            content: popoverContent.innerHTML,
            container: "body",
            trigger: "manual",
            sanitize: false,
          });
        }
        if (filterBtn.classList.contains("active")) {
          bsPopover.hide();
          filterBtn.classList.remove("active");
        } else {
          bsPopover.show();
          filterBtn.classList.add("active");
          setTimeout(bindFilterEvents, 200);
        }
      });

      function bindFilterEvents() {
        let $cat = $("body .popover #categoryFilter"),
          $lev = $("body .popover #levelFilter"),
          $range = $("body .popover #dateRange"),
          $reset = $("body .popover #resetFilter");

        $cat.on("change", function () {
          table.column(1).search(this.value, false, false).draw();
        });
        $lev.on("change", function () {
          table.column(2).search(this.value, false, false).draw();
        });

        let minDate, maxDate;
        $range.daterangepicker({
          locale: {
            format: "YYYY-MM-DD",
            cancelLabel: "Clear",
            applyLabel: "Filter",
          },
          autoUpdateInput: false,
          opens: "left",
        });

        $range.on("apply.daterangepicker", function (ev, picker) {
          minDate = picker.startDate.format("YYYY-MM-DD");
          maxDate = picker.endDate.format("YYYY-MM-DD");
          $(this).val(minDate + " s/d " + maxDate);
          table.draw();
        });
        $range.on("cancel.daterangepicker", function () {
          $(this).val("");
          minDate = maxDate = null;
          table.draw();
        });

        $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(
          (f) => !f.name || f.name !== "dateRangeFilter"
        );
        $.fn.dataTable.ext.search.push(function dateRangeFilter(
          settings,
          data,
          dataIndex
        ) {
          if (!minDate || !maxDate) return true;
          let tanggal = data[0] || "";
          let tglRow = moment(tanggal, "M/D/YYYY, h:mm:ss A");
          if (!tglRow.isValid()) return true;
          return (
            tglRow.isSameOrAfter(minDate) && tglRow.isSameOrBefore(maxDate)
          );
        });

        $reset.on("click", function () {
          $cat.val("");
          table.column(1).search("", false, false).draw();
          $lev.val("");
          table.column(2).search("", false, false).draw();
          $range.val("");
          minDate = maxDate = null;
          table.draw();
        });
      }

      // --- Auto refresh setiap 100 detik ---
      setInterval(() => location.reload(), 100000);
    </script>
  </body>
</html>
